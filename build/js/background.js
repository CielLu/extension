function CSV(){}CSV.prototype={formatCSV:function(e){return null==e?"":"number"==typeof e?e:"object"==typeof e?JSON.stringify(e):'"'+(e=e.replace(/"/g,'""'))+'"'},createCSV:function(e,t){var n=this.formatCSV,a=null;e&&e.length&&(a=e.map(function(e){return n(e.heading)}).join());var o=t.map(function(e){return e.map(function(e){return n(e)}).join()}).join("\r\n");return a?a+"\r\n"+o:o},getStrCSV:function(e,t){return this.createCSV(e,t)},getHrefCSV:function(e,t){var n=this.createCSV(e,t);return URL.createObjectURL(new Blob([n]))},downloadCSV:function(e,t,n){var a=this.createCSV(e,t);this.download(a,n,"application/csv")},download:function(e,t,n){var a=navigator.userAgent.toLowerCase(),o=!1;if(-1!==a.indexOf("safari")&&-1===a.indexOf("chrome"))try{return void window.open("data:"+n+" ;base64,"+btoa(e))}catch(e){o=!0,n="text/plain;charset=UTF-8;"}var r=new Blob([e],{type:n});if(window.navigator.msSaveBlob)window.navigator.msSaveBlob(r,t);else{var i=window.URL.createObjectURL(r);if(o)window.open(i);else{var s=document.createElement("a");document.body.appendChild(s),s.style="display: none",s.href=i,s.download=t,s.click()}setTimeout(function(){window.URL.revokeObjectURL(i)},2e4)}}};var AiApi=function(){this.path="http://localhost:7700/sm"};AiApi.prototype={inference:function(e,t,n){$.ajax({type:"POST",url:this.path+"/inference",success:e,data:JSON.stringify(n),error:t,dataType:"json",contentType:"application/json"})}};var AuthenticationApi=function(e){this.path=e};AuthenticationApi.prototype={signIn:function(e,t,n,a){$.ajax({type:"POST",url:this.path+"/grabbly/api/v1/authenticate",success:e,data:JSON.stringify({email:n,password:a}),xhrFields:{withCredentials:!0},credentials:"same-origin",error:t,dataType:"json",contentType:"application/json"})},signUp:function(e,t,n,a,o,r){$.ajax({type:"POST",url:this.path+"/grabbly/api/v1/create_user",data:JSON.stringify({email:n,first_name:a,last_name:o,password:r}),success:e,error:t,dataType:"json",contentType:"application/json"})}};var ScheduleApi=function(e){this.path=e};ScheduleApi.prototype={get:function(e,t,n){$.ajax({type:"POST",url:this.path+"/grabbly/api/v1/schedules",success:e,error:t,dataType:"json",contentType:"application/json",data:JSON.stringify({pageNumber:n||0})})},delete:function(e,t,n){$.ajax({type:"DELETE",url:this.path+"/grabbly/api/v1/delete_schedule/"+n,success:e,error:t,dataType:"text"})},update:function(e,t,n,a){$.ajax({type:"PUT",url:this.path+"/grabbly/api/v1/update_schedule/"+n,data:JSON.stringify(a),success:e,error:t,dataType:"text",contentType:"application/json"})},create:function(e,t,n){$.ajax({type:"POST",url:this.path+"/grabbly/api/v1/create_schedule",data:JSON.stringify(n),success:e,error:t,dataType:"json",contentType:"application/json"})}};var SurveyApi=function(e){this.path=e};SurveyApi.prototype={get:function(e,t){$.ajax({type:"GET",url:this.path+"/survey/api/v1/get_survey",success:e,error:t,contentType:"application/json"})},post:function(e,t,n){$.ajax({type:"POST",url:this.path+"/survey/api/v1/set_answers",success:e,error:t,dataType:"json",contentType:"application/json",data:JSON.stringify(n)})}};var JobApi=function(e){this.path=e};JobApi.prototype={get:function(e,t,n){$.ajax({type:"POST",url:this.path+"/grabbly/api/v1/jobs_url",success:e,error:t,dataType:"json",contentType:"application/json",data:JSON.stringify({url:n})})},getFiltered:function(e,t,n){$.ajax({type:"POST",url:this.path+"/grabbly/api/v1/jobs_url_filtered",success:e,error:t,dataType:"json",contentType:"application/json",data:JSON.stringify({url:n})})},getFilteredAndMine:function(e,t,n){$.ajax({type:"POST",url:this.path+"/grabbly/api/v1/jobs_url_filtered_and_mine",success:e,error:t,dataType:"json",contentType:"application/json",data:JSON.stringify({url:n})})},getPopularAndMine:function(e,t,n){$.ajax({type:"POST",url:this.path+"/grabbly/api/v1/jobs_popular_and_mine",success:e,error:t,dataType:"json",contentType:"application/json",data:JSON.stringify({url:n})})},getMyJobs:function(e,t,n){$.ajax({type:"POST",url:this.path+"/grabbly/api/v1/my_jobs",success:e,error:t,data:JSON.stringify({page_number:n||0}),dataType:"json",contentType:"application/json"})},getById:function(e,t,n){$.ajax({type:"GET",url:this.path+"/grabbly/api/v1/job/"+n,success:e,error:t,dataType:"json"})},create:function(e,t,n){$.ajax({type:"POST",url:this.path+"/grabbly/api/v1/create_job",data:JSON.stringify(n),success:e,error:t,dataType:"json",contentType:"application/json"})},update:function(e,t,n,a){$.ajax({type:"PUT",url:this.path+"/grabbly/api/v1/job/"+n,data:JSON.stringify(a),success:e,error:t,dataType:"text",contentType:"application/json"})},delete:function(e,t,n){$.ajax({type:"DELETE",url:this.path+"/grabbly/api/v1/job/"+n,success:e,error:t,dataType:"text"})},upload:function(e,t,n,a){$.ajax({type:"POST",url:a,data:n,processData:!1,contentType:!1,success:e,error:t})},reportActivity:function(e,t,n,a){$.ajax({type:"POST",url:this.path+"/grabbly/api/v1/report_activity",data:JSON.stringify({quota:n,jobId:a}),success:e,error:t,contentType:"application/json",dataType:"json"})},retrieveQuota:function(e,t){$.ajax({type:"GET",url:this.path+"/grabbly/api/v1/retrieve_quota",success:e,error:t,dataType:"json"})},getVideoUrls:function(e,t){$.ajax({type:"GET",url:this.path+"/grabbly/api/v1/get_video_urls",success:e,error:t,dataType:"json"})},getHowItWorksVideos:function(e,t){$.ajax({type:"GET",url:this.path+"/grabbly/api/v1/get_how_it_works_videos",success:e,error:t,dataType:"json"})}};var environment=null,mode=null,email="",jobApi=null,authenticationApi=null,aiApi=null,scheduleApi=null,surveyApi=null;function setEnvironment(e){"DEV"==e.environment?(environment="http://localhost:8080",environment="https://localhost:8443",environment="https://www.grabbly.io"):environment="https://www.grabbly.io",aiApi=new AiApi(environment),jobApi=new JobApi(environment),surveyApi=new SurveyApi(environment),authenticationApi=new AuthenticationApi(environment),scheduleApi=new ScheduleApi(environment)}function fail(e,t,n){console.log(e),console.log(t+" : "+e.responseText+" : "+n),status("Failure",!1),window.parent.postMessage({method:"status",data:JSON.stringify({jqXHR:e,textStatus:t,errorThrown:n})},"*")}function spinnerFail(e,t,n){$("#spinner").hide(),fail(e,t,n)}function formatRecipes(e){return e.map(function(e){var t=JSON.parse(e.data);return t.id=e.id,t.owner=e.owner,t.public=e.public,t.isPopular=!!e.type,t})}function formatSchedules(e){return e.map(function(e){var t=e.data;return t.id=e.id,t})}function status(e,t,n){n||(n=3e3),$("#status").addClass("show"),$("#status").text(e),setTimeout(function(){$("#status").removeClass("show")},n)}function urlToFilename(e){return e.replace(/[^-a-zA-Z0-9\.]+/g,"_")}function addToZip(e,t,n){e.file(t,n)}function createZip(){return new JSZip}function getTestData(){for(var e=[],t=0;t<1e4;t++){for(var n=[],a=0;a<25;a++)n.push("my test test of all tests");e.push(n)}return(new CSV).getStrCSV([],e)}function splitData(e,t,n,a,o){for(var r=[],i=e.length%t>0?1:0,s=0;s<parseInt(e.length/t,10)+i;s++){var u=s*t+t>e.length?e.length:s*t+t,l=e.slice(s*t,u);"CSV"===a?r.push({apiEndpoint:o,name:n+"-"+s+".csv",data:(new CSV).getStrCSV([],l)}):r.push({apiEndpoint:o,name:n+"-"+s+".json",data:JSON.stringify(l)})}return r}function uuidv4(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}function formatDate(e){e||(e=new Date);var t=e.getHours(),n=e.getMinutes(),a=e.getMonth()+1,o=e.getDate(),r=e.getFullYear(),i=e.getSeconds();return r+"-"+(a=a<10?"0"+a:a)+"-"+(o=o<10?"0"+o:o)+" "+((t=t<10?"0"+t:t)+":"+(n=n<10?"0"+n:n)+":"+(i=i<10?"0"+i:i)+":"+e.getMilliseconds())}function b64toBlob(e,t,n){t=t||"",n=n||512;for(var a=atob(e.split(",")[1]),o=[],r=0;r<a.length;r+=n){for(var i=a.slice(r,r+n),s=new Array(i.length),u=0;u<i.length;u++)s[u]=i.charCodeAt(u);var l=new Uint8Array(s);o.push(l)}return new Blob(o,{type:t})}function attachAutocomplete(e,t){$(e).textcomplete([{words:t,match:/\b(\w{2,})$/,search:function(e,t){t($.map(this.words,function(t){return t.indexOf(e)>-1?t:null}))},index:1,replace:function(e){return e+" "}}])}function loadDropdown(e,t,n){$(e).empty();var a="";a+="<option value=''></option>";for(var o=0;o<t.length;o++)a+="<option value='"+t[o].id+"'>"+t[o][n||"name"]+"</option>";$(e).append(a)}function traverseClean(e){if(e.localName&&e.localName.toLowerCase()in{script:void 0,style:void 0})$(e).remove();else for(var t=e.childNodes,n=0;n<t.length;n++)traverseClean(t[n])}function cleanNode(e){if(e.nodeType!==Node.COMMENT_NODE){if(!isValidNode(e))return!1;$(e).removeClass(),$(e).removeAttr("id"),$(e).attr("href")&&$(e).attr("href",e.href);for(var t=0;t<e.attributes.length;t++)"href"!=e.attributes[t].name&&$(e).removeAttr(e.attributes[t].name);var n=e.childNodes;for(t=0;t<n.length;t++)cleanNode(n[t])}else $(e).remove()}function traverse(e,t,n,a){if(!n||!isValidNode(e)||!1!==n(e,t)){for(var o=e.childNodes,r=0;r<o.length;r++)traverse(o[r],t+1,n,a);!a||!isValidNode(e)||a(e,t)}}var regexCache={};function regexTest(e,t){if(!e)return!0;if(!e.trim())return!0;var n=e.split("\n").map(function(e){return e.trim()});n.map(function(e){e in regexCache||(regexCache[e]=new RegExp(e))});for(var a=0;a<n.length;a++)if(t.match(regexCache[n[a]]))return!0;return!1}var entityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function escapeHtml(e){return String(e).replace(/[&<>"'`=\/]/g,function(e){return entityMap[e]})}function getOwnText(e){try{for(var t=$(e).contents().filter(function(){return 3==this.nodeType}),n="",a=0;a<t.length;a++)n+=t[a].nodeValue,a<t.length-1&&(n+="");return n}catch(e){return""}}function getOwnHtml(e){return $(createElement(e.outerHTML)).clone().children().remove().end().html()}function getJobDependencies(e,t,n,a,o,r){e||(e=[]),e=(e=Array.from(new Set(e))).filter(function(e){return!!e}).map(function(e){return parseInt(e,10)}).filter(function(e){return a?!(e in n):!(e in t)});for(var i=0;i<e.length;i++)r.cnt+=1,jobApi.getById(function(e){r.cnt-=1,formatRecipes([e]).map(function(e){if(a?n[e.id]=e:t[e.id]=e,getJobDependencies(e.links,t,n,a||!1,o,r),getJobDependencies(e.row.visitUrlJobs,t,n,!0,o,r),e.columns)for(var i=0;i<e.columns.length;i++)getJobDependencies(e.columns[i].visitUrlJobs,t,n,!0,o,r);if(e.details)for(i=0;i<e.details.length;i++)getJobDependencies(e.details[i].visitUrlJobs,t,n,!0,o,r);0===r.cnt&&o&&o(t,n)})},fail,e[i])}function isValidNode(e){return!(1!==e.nodeType||e.localName.toLowerCase()in{script:void 0,style:void 0})}function createElement(e){var t=document.createElement("template");return t.innerHTML=e,t.content.firstChild}function createElementFragment(e){var t=document.createDocumentFragment(),n=document.createElement("div");for(n.innerHTML=e;n.firstChild;)t.appendChild(n.firstChild);return t}function move(e,t,n){for(;t<0;)t+=e.length;for(;n<0;)n+=e.length;if(n>=e.length)for(var a=n-e.length;1+a--;)e.push(void 0);return e.splice(n,0,e.splice(t,1)[0]),e}function combination(e,t){var n=[];if(n.push(e),0===t.length)return n;for(var a=0;a<t.length;a++){var o=e.slice(0);o.push(t[a]),n=n.concat(combination(o,t.slice(a+1)))}return n}function createSequence(e){for(var t=[],n=0;n<e;n++)t.push(0);return t}function getNumericCnt(e){for(var t=0,n=0;n<e.length;n++)new Set("0123456789".split("")).has(e[n])&&(t+=1);return t}function getAddresses(e){var t=[];return new Address(e).runPipeline(),$(e).find(".grabbly-address").each(function(e){t.push($(this).text().replace(/  |\r\n|\n|\r|\t/gm," "))}),t}function getPhones(e){var t=e.match(/(?:(?:\+?([1-9]|[0-9][0-9]|[0-9][0-9][0-9])\s*(?:[.-]\s*)?)?(?:\(\s*([2-9]1[02-9]|[2-9][02-8]1|[2-9][02-8][02-9])\s*\)|([0-9][1-9]|[0-9]1[02-9]|[2-9][02-8]1|[2-9][02-8][02-9]))\s*(?:[.-]\s*)?)?([2-9]1[02-9]|[2-9][02-9]1|[2-9][02-9]{2})\s*(?:[.-]\s*)?([0-9]{4})(?:\s*(?:#|x\.?|ext\.?|extension)\s*(\d+))?/g)||[];return t=(t=(t=(t=Array.from(new Set(t))).filter(function(e){return!!e})).map(function(e){return e.trim()})).filter(function(e){var t=getNumericCnt(e);return!!new Set([7,10,11,12,13]).has(t)&&(!!new Set([1,3]).has(e.split(".").length)&&!(t>6&&t===e.length))}),Array.from(new Set(t))}function getRowGroups(e){for(var t={},n=0;n<e.length;n++)null!=e[n].row&&(e[n].row in t||(t[e[n].row]=[]),t[e[n].row].push(e[n]),e[n].index=n);return t}function getEmails(e){for(var t=[],n=[],a=-1,o=new Set(['"',";",":","<",">"," ","/","\\","{","}","&","?","(",")","$","=","\n","\r\n","\t"]),r=0;r<e.length;r++)r===e.length-1||o.has(e[r])||a>-1&&"@"==e[r]?(a>0&&a<n.length-1&&t.push(n.join("").trim()),n=[],a=-1):("@"==e[r]&&(a=n.length),n.push(e[r]));return Array.from(new Set(t))}console.log("Grabbly background loaded");var CrawlJob=function(){this.jobLookupByJobId={},this.urlsQueue=[],this.urlsVisited={},this.urlIndex=0,this.maxOpenTabs=1,this.openTabCnt=0,this.path={},this.dataLookupByJobId={},this.pause=!1},crawlJobs={},tabs={},ROWS_PER_FILE=1e4,isOn=!0,captures=[],quotaLeft=0,sortedFiles={},schedules=null,autoOpen=null,downloadQueue=[],maxDownloads=5,downloadCount=0,uniqueUrlsOnly={},manifest=chrome.runtime.getManifest(),initConfig={name:manifest.name,environment:manifest.name.indexOf("dev")>-1?"DEV":"PROD",description:manifest.description};function sortFiles(e){for(var t={},n=0;n<e.length;n++){(a=e[n].jobId)in t||(t[a]=[]),t[a].push(e[n])}for(var a in t)t[a].sort(function(e,t){return e.date<t.date?-1:1});return t}function getLocalFiles(){chrome.storage.local.get(null,function(e){var t=[];for(var n in e)e[n].id=n,t.push(e[n]);sortedFiles=sortFiles(t)})}function downloadLink(e){for(var t=0;t<e.length;t++){var n="grabbly/"+e[t].url,a="grabbly/"+e[t].filename;downloadCount<maxDownloads?(downloadCount+=1,chrome.downloads.download({url:n,filename:a},function(e){if(downloadCount-=1,console.log("download complete 2: "+e),downloadQueue.length&&downloadCount<maxDownloads){var t=downloadQueue.pop();downloadLink(t.url,t.filename)}else console.log("wait download")})):(console.log("wait download"),downloadQueue.push({url:n,filename:a}))}}function crawlJobExportFile(e){var t=getFile(e);e.jobId in sortedFiles||(sortedFiles[e.jobId]=[]),sortedFiles[e.jobId].unshift(t);var n={};n[e.id]=t,chrome.storage.local.set(n,function(){});var a=e.apiEndpoint.trim();a&&uploadFileToApiEndpoint(a,sortedFiles[e.jobId][0],e.jobId,e.name)}function removeTab(e){if(e in tabs){var t=tabs[e],n=t.crawlJob;delete tabs[e],t.crawlJob.openTabCnt>0&&t.crawlJob.openTabCnt--,n.id in crawlJobs?openTabs(t.crawlJob):console.log(" Crawl Job does not exist!"),n.tabsRemovedCount++,n.tabsRemovedCount>=n.urlsQueue.length&&(t.crawlJob.windowId&&chrome.windows.remove(t.crawlJob.windowId,function(){}),updateQuota(getTotalRows(t.crawlJob),!0,t.crawlJob.jobId),crawlJobExportFile(t.crawlJob),delete crawlJobs[t.crawlJob.id],chrome.tabs.query({},function(e){for(var t=0;t<e.length;t++)chrome.tabs.sendMessage(e[t].id,{method:"isCrawlingDone",data:!0})}))}}function uploadFileToApiEndpoint(e,t,n,a){for(var o=createZip(),r=0;r<t.splits.length;r++)for(var i=0;i<t.splits[r].length;i++)addToZip(o,t.splits[r][i].name,t.splits[r][i].data);o.generateAsync({type:"blob",compression:"deflate"}).then(function(o){var r=new FormData;r.append("fname",t.name+".zip"),r.append("data",o),r.append("grabbId",n),r.append("grabbName",a),jobApi.upload(function(){updateStatus("Success sending to api endpoint"+e)},function(){updateStatus("Error sending to api endpoint"+e)},r,e)})}function getFile(e){return{id:e.id,url:e.url,jobId:e.jobId,date:formatDate(new Date),splits:getSplits(e),name:e.name}}function getTotalRows(e){var t=0;for(var n in e.dataLookupByJobId){t+=e.dataLookupByJobId[n].length}return t}function getSplits(e){var t={};for(var n in e.dataLookupByJobId){if((r=e.dataLookupByJobId[n]).length>1)for(var a=1;a<r.length;a++)t[r[a][0]]={row:r[a],children:[],headers:r[0],jobId:n}}var o=[];for(var n in e.dataLookupByJobId){var r;if((r=e.dataLookupByJobId[n]).length>1)for(a=1;a<r.length;a++)r[a][1]?t[r[a][1]].children.push(r[a][0]):o.push(r[a][0])}var i=[],s=[];for(a=0;a<o.length;a++)s=s.concat(innerJoin(o[a],t,0,i,[]));for(var u=[],l=[],d=0,c=0;c<Object.keys(i).length;c++)for(a=0;a<i[c].headers.length;a++){for(var p=0;p<(0===d?4:5);p++)l.push(d+p);d+=i[c].headers[a].length,u=u.concat(i[c].headers[a])}for(c=0;c<Object.keys(i).length;c++)i[c].endPosition=i[c].headers.reduce(function(e,t){return e+t.length},0);var f=[];for(a=0;a<s.length;a++){var h=[];for(c=0;c<s[a].length;c++){n=s[a][c][2];for(var b=i[c].jobIds[n].startPosition,m=i[c].endPosition,g=s[a][c][4],w=0;w<b;w++)4===w?h.push(g):h.push("");h=h.concat(s[a][c]);for(w=b+s[a][c].length;w<m;w++)h.push("")}f.push(h)}function v(e,t){for(var n=t.length-1;n>=0;n--){var a=t[n];e=e.map(function(e){return e.splice(a,1),e})}}function y(e,t,n){for(var a=1;a<e.length;a++){var o=e[a];(o[t]&&o[n]&&(o[t]+"").trim().length>(o[n]+"").trim().length||o[t]&&!o[n])&&(o[n]=o[t])}}if((s=f).unshift(u),v(s,l),e.mergeColumns){l=[];for(a=0;a<s[0].length;a++){var x=s[0][a];if("url"!=x.toLowerCase())for(p=s[0].length-1;p>a;p--){x==s[0][p]&&(console.log("duplicate column "+x),y(s,p,a),l.push(p))}}(l=Array.from(new Set(l))).sort(function(e,t){return e-t}),v(s,l)}if(e.deleteEmptyRows)for(a=1;a<s.length;a++){var T=!1;for(p=1;p<s[0].length;p++)if(s[a][p]&&(s[a][p]+"").trim().length>0){T=!0;break}T||(s.splice(a,1),a--)}var I=[];return s.length>1&&I.push(splitData(s,ROWS_PER_FILE,e.name,"CSV",null)),I}function innerJoin(e,t,n,a,o){var r=t[e].row,i=t[e].children,s=t[e].headers,u=t[e].jobId;n in a||(a[n]={jobIds:{},headers:[]}),u in a[n].jobIds||(a[n].jobIds[u]={index:a[n].headers.length,startPosition:a[n].headers.reduce(function(e,t){return e+t.length},0)},a[n].headers.push(s));for(var l=[],d=0;d<i.length;d++){var c=o.slice(0);c.push(r),l=l.concat(innerJoin(i[d],t,n+1,a,c))}return i.length?l:(o.push(r),[o])}function updateStatus(e){console.log(e),chrome.tabs.query({active:!0,currentWindow:!0},function(t){t.length&&chrome.tabs.sendMessage(t[0].id,{method:"updateStatus",data:e},function(e){})})}function updateQuota(e,t,n){e>0&&jobApi.reportActivity(function(e){quotaLeft=e.quota_left,t&&broadcastQuotaLeft(e.quota_left)},fail,e,n)}function broadcastQuotaLeft(e){console.log(e),chrome.tabs.query({active:!0,currentWindow:!0},function(t){t.length&&chrome.tabs.sendMessage(t[0].id,{method:"quotaLeft",data:e},function(e){})})}function open(e,t,n,a){if(e.pause&&1==e.maxOpenTabs)return e.urlIndex-=1,void(e.openTabCnt>0&&e.openTabCnt--);chrome.tabs.query({active:!0,currentWindow:!0},function(o){!e.runThisTab||e.schedule||1!==e.urlIndex||!o.length||o[0].id in tabs?openWindow(e,t,n,a):(tabs[o[0].id]={url:t,stack:[t],created:new Date,crawlJob:e,closeAfterCrawl:!1,parentId:n,jobIds:a},chrome.tabs.sendMessage(o[0].id,{method:"startCrawlFromActive"},function(e){}))})}function openWindow(e,t,n,a){e.windowId?chrome.windows.getCurrent(function(o){chrome.tabs.create({url:t,active:!0,selected:!1,windowId:e.windowId},function(o){if(!o||!o.id)return e.windowId=null,void openWindow(e,t,n,a);tabs[o.id]={url:t,stack:[t],created:new Date,crawlJob:e,closeAfterCrawl:!0,parentId:n,jobIds:a}})}):chrome.windows.getCurrent(function(o){chrome.windows.create({focused:!1,state:"minimized"},function(o){chrome.tabs.create({url:t,active:!0,selected:!1,windowId:o.id},function(r){e.windowId=o.id,tabs[r.id]={url:t,stack:[t],created:new Date,crawlJob:e,closeAfterCrawl:!0,parentId:n,jobIds:a}})})})}function smokeTestRuntime(){for(var e={test:!0,mimicHuman:!0},t=0,n=0;n<60;n++){t+=a=nextRuntime(e),console.log("Test "+n+" = "+parseInt(t/1e3/60,10)+" min = "+parseInt(a/1e3,10)+" secs")}for(t=0,n=0;n<60;n++){var a;(e={test:!0}).mimicHuman=!0,t+=a=nextRuntime(e),console.log("Create Test "+n+" = "+parseInt(t/1e3/60,10)+" min = "+parseInt(a/1e3,10)+" secs")}}function nextRuntime(e){if(!e.mimicHuman)return 0;var t=new Date;if(runInThisHour(e,t)){if(t.getHours()!=e.runHour&&(e.runHour=t.getHours(),e.runsInThisHour=0),e.runsInThisHour>125)return console.log("Run in next hour"),timeTillNextHour(t);var n=36e5/(25+100*Math.random());return e.runsInThisHour+=1,parseInt(n,10)}return console.log("Run in next hour"),timeTillNextHour(t)}function timeTillNextHour(e){return 60*(61-e.getMinutes())*100}function runInThisHour(e,t){var n=t.getHours();return!(e.runHour!=n&&!e.test)||Math.random()>.3}function openTabs(e){if(!e.pause)for(;e.openTabCnt<e.maxOpenTabs&&e.urlIndex<e.urlsQueue.length;e.urlIndex++){e.openTabCnt++;var t=0===e.urlIndex?0:nextRuntime(e);updateStatus("Next Grabb will happen in "+parseInt(t/1e3,10)+" seconds");var n=e.urlsQueue[e.urlIndex].url,a=e.urlsQueue[e.urlIndex].parentId,o=e.urlsQueue[e.urlIndex].jobIds;setTimeout(open,t,e,n,a,o)}}function queueLinks(e,t,n,a){if("crawl"!==a.type||n||!(a.urlsVisited[t]>=a.crawl.maxCrawlDepth)){for(var o=0;o<e.length;o++){var r=e[o].url,i=e[o].jobIds,s=e[o].rowId;r&&((r.toLowerCase().startsWith("http:")||r.toLowerCase().startsWith("https:"))&&("crawl"!==a.type||regexTest(a.crawl.crawlRegexes,r))&&(r in a.urlsVisited&&!n||(n?a.urlsVisited[t]=0:(a.urlsVisited[r]=a.urlsVisited[t]+1,a.path[r]=t),a.urlIndex<=1?a.urlsQueue.push({url:r,jobIds:i,parentId:s}):a.urlsQueue.splice(a.urlIndex,0,{url:r,jobIds:i,parentId:s}))))}openTabs(a)}}function startCrawl(e,t){if(quotaLeft<=0)return!1;e.filter(function(e){for(var t in crawlJobs)if(e.id==crawlJobs[t].jobId)return!1;return!0}).map(function(e){var n=new CrawlJob;n.id=uuidv4(),crawlJobs[n.id]=n,n.jobId=e.id,n.name=e.name,n.mimicHuman=e.mimicHuman,n.maxOpenTabs=parseInt(e.numberTabs,10),n.apiEndpoint=e.apiEndpoint,n.numPages=0,n.crawlOnActiveTab=e.crawlOnActiveTab,n.makeTabActive=e.makeTabActive,n.type=e.type,n.crawl=e.crawl,n.runsInThisHour=0,n.tabsRemovedCount=0,n.runHour=-1,n.url=e.url,n.pause=!1,n.pauseTimestamp=Date.now(),n.regexes=e.regexes,n.schedule=t,n.runThisTab=e.runThisTab,n.mergeColumns=e.mergeColumns,n.deleteEmptyRows=e.deleteEmptyRows;var a=[e.id].concat(e.links||[]).map(function(e){return parseInt(e,10)});queueLinks([{url:e.url,jobIds:a}],e.url,!0,n)}),console.log("Start Crawl!")}function addLinksToCrawl(e,t,n){0===Object.keys(e.urlsVisited).length?(console.log("Start Crawl!"),queueLinks(t,n,!0,e)):queueLinks(t,n,!1,e)}function checkQuotaStartCrawl(e,t){jobApi.retrieveQuota(function(n){broadcastQuotaLeft(quotaLeft=n.quota_left),startCrawl(e,t)},fail)}function capture(e){return chrome.tabs.captureVisibleTab(null,{format:"png"},function(t){captures.push({blob:b64toBlob(t,"image/png"),x:request.data.x,y:request.data.y,height:request.data.height,width:request.data.width}),e({method:"captureNext",data:""})}),!1}function captureDone(){for(var e=document.createElement("canvas"),t=0;t<captures.length;++t){var n=captures[t],a=n.x,o=n.y,r=n.blob;0==t&&(e.width=n.width,e.height=n.height);var i=a-0,s=o-0;e.getContext("2d").drawImage(r,i,s)}}function extractDone(e,t,n){e&&(console.log(e.urlIndex+" / "+e.urlsQueue.length+" closing tab : ("+n.stack.length+") "+n.stack.join("\n")),n.closeAfterCrawl?chrome.tabs.remove(t.tab.id,function(){}):(chrome.tabs.sendMessage(t.tab.id,{method:"stopCrawling",data:""},function(e){}),removeTab(t.tab.id)))}function setData(e,t,n){e&&(e.data.map(function(e){var a=e[2];if(!(a in t.dataLookupByJobId)){var o=[];if(o.push("Row Id"),o.push("Parent Id"),o.push("Job Id"),o.push("Job Name"),o.push("Url"),a in t.jobLookupByJobId)var r="list"===t.jobLookupByJobId[a].type?t.jobLookupByJobId[a].columns:t.jobLookupByJobId[a].details;else r="list"===t.refJobs[a].type?t.refJobs[a].columns:t.refJobs[a].details;for(var i=0;i<r.length;i++)o.push(r[i].columnName);t.dataLookupByJobId[a]=[o]}e[1]||(e[1]=n.parentId),t.dataLookupByJobId[a].push(e)}),quotaLeft-=e.data.length,t.numPages+=e.numPages,quotaLeft<=0&&(t.pause=!0,deleteByJobId(t.jobId),updateQuota(getTotalRows(t),!0,t.jobId)))}function autoExtract(e,t,n,a){function o(n,o){n=n.filter(function(t){if(t.uniqueUrlsOnly){if(t.id in uniqueUrlsOnly||(uniqueUrlsOnly[t.id]={}),e.stack[e.stack.length-1]in uniqueUrlsOnly[t.id])return!1;uniqueUrlsOnly[t.id][e.stack.length-1]=!0}else t.id in uniqueUrlsOnly&&delete uniqueUrlsOnly[t.id];return!0});var r={autoOpen:autoOpen,jobs:n,autoExtract:!0,tabStack:e?e.stack:null,crawlJobId:a.id,refJobs:o};autoOpen=null,t({method:"autoExtract",data:r})}if(null===a)return t({method:"autoExtract",data:{autoOpen:autoOpen,autoExtract:!1}}),autoOpen=null,!1;e.url=n,e.stack.push(n),e.created=new Date;for(var r=new Set,i=0;i<e.jobIds.length;i++)e.jobIds[i]in a.jobLookupByJobId||r.add(e.jobIds[i]);return r.size?getJobDependencies(Array.from(r),{},{},!1,function(t,n){e.jobIds=Object.keys(t).map(function(e){return parseInt(e,10)}),a.schedule&&a.schedule.pageCounts&&(Object.keys(t).map(function(e){t[e].navigate.maxClicks=null,e in a.schedule.pageCounts&&(t[e].navigate.maxClicks=parseInt(a.schedule.pageCounts[e],10))}),Object.keys(n).map(function(e){n[e].navigate.maxClicks=null,e in a.schedule.pageCounts&&(n[e].navigate.maxClicks=parseInt(a.schedule.pageCounts[e],10))})),a.jobLookupByJobId=t,a.refJobs=n,o(e.jobIds.map(function(e){return a.jobLookupByJobId[e]}),a.refJobs)},{cnt:0}):(e.jobIds=function(e){for(var t=new Set;e.length;){var n=e.pop();t.add(n);var o=a.jobLookupByJobId[n].links;if(o)for(var r=0;r<o.length;r++){var i=parseInt(o[r],10);t.has(i)||e.push(i)}}return Array.from(t)}(e.jobIds.slice(0)),o(e.jobIds.map(function(e){return a.jobLookupByJobId[e]}),a.refJobs)),!0}function getFileFromSortedFiles(e){for(var t in sortedFiles)for(var n=0;n<sortedFiles[t].length;n++)if(e==sortedFiles[t][n].id)return sortedFiles[t][n];return null}function getFileFromCrawlJobs(e){for(var t in crawlJobs)if(e==crawlJobs[t].id)return getFile(JSON.parse(JSON.stringify(crawlJobs[t])));return null}function getZip(e){for(var t=createZip(),n=0;n<e.splits.length;n++)for(var a=0;a<e.splits[n].length;a++)addToZip(t,e.splits[n][a].name,e.splits[n][a].data);return t}function downloadCSV(e,t){var n=getFileFromCrawlJobs(e);if(null===n&&(n=getFileFromSortedFiles(e)),0===n.splits.length){var a=new Blob([""],{type:"text/csv"}),o=window.URL.createObjectURL(a);return t(o,"csv"),!1}if(1===n.splits.length&&1===n.splits[0].length){a=new Blob([n.splits[0][0].data],{type:"text/csv"}),o=window.URL.createObjectURL(a);return t(o,"csv"),!1}return getZip(n).generateAsync({type:"blob",compression:"deflate"}).then(function(e){var n=window.URL.createObjectURL(e,{type:"application/zip"});t(n,"zip")}),!0}function deleteByJobId(e){var t=[];if(e in sortedFiles)for(var n=0;n<sortedFiles[e].length;n++)t.push(sortedFiles[e][n].id);chrome.storage.local.remove(t),deleteExtractByJobId(e)}function deleteExtractByJobId(e){for(var t in crawlJobs)if(e==crawlJobs[t].jobId)return void deleteExtractByCrawlId(t)}function deleteExtractByCrawlId(e){for(var t in tabs)tabs[t].crawlJob.id==e&&(delete tabs[t],chrome.tabs.get(parseInt(t,10),function(e){e&&(e.active?chrome.tabs.sendMessage(e.id,{method:"extractStop",data:!0}):chrome.tabs.remove(e.id,function(){}))}));if(e in crawlJobs){var n=crawlJobs[e];n.windowId&&chrome.windows.remove(n.windowId,function(){}),crawlJobExportFile(n),delete crawlJobs[e]}}function getFiles(){var e={};for(var t in sortedFiles){e[t]=[];for(var n=0;n<sortedFiles[t].length;n++)e[t].push({id:sortedFiles[t][n].id,jobId:t,isDone:!0,date:sortedFiles[t][n].date,name:sortedFiles[t][n].name,url:sortedFiles[t][n].url})}for(var a in crawlJobs){t=crawlJobs[a].jobId;var o=crawlJobs[a].id;t in e||(e[t]=[]),e[t].unshift({id:o,jobId:t,isDone:!1,date:formatDate(new Date),name:crawlJobs[a].name,urlIndex:crawlJobs[a].urlIndex,urlLength:crawlJobs[a].urlsQueue.length,pause:crawlJobs[a].pause,pauseTimestamp:crawlJobs[a].pauseTimestamp,url:crawlJobs[a].url})}return e}var isLooping=!1;function getSchedules(e){isLooping&&!e||(isLooping&&console.log("In a loop!"),scheduleApi.get(function(e){schedules=formatSchedules(e),launchSchedules(),isLooping=!1},function(){console.log("unable to get schedules"),isLooping=!0,setTimeout(getSchedules,18e4,!0)}))}function getCrawlJobByScheduleId(e){for(var t in crawlJobs){var n=crawlJobs[t];if(n.schedule&&n.schedule.id==e)return crawlJobs[t]}return null}function runSchedule(e){getNextScheduleTime(e),getCrawlJobByScheduleId(e.id)||jobApi.getById(function(t){(t=formatRecipes([t])[0]).url=e.url,t.apiEndpoint=e.apiEndpoint,checkQuotaStartCrawl([t],e)},function(){console.log("Unable to get job, deleting schedule for job id: "+e.jobId),scheduleApi.delete(function(){console.log("Successfully delete schedule id"+e),getSchedules()},fail,e.jobId)},e.jobId)}function checkRuntime(){if(schedules)for(var e=0;e<schedules.length;e++){var t=schedules[e],n=t.nextTime.diff(moment()),a=parseInt(n/1e3/60,10);console.log(t.jobId+" - "+a+" minutes"),n<=0&&runSchedule(t)}setTimeout(checkRuntime,6e4)}function getNextScheduleTime(e){for(var t=e.nextTime?e.nextTime:moment(`${e.startDate} ${e.startTime}`);;){if(t.diff(moment())>0)return void(e.nextTime=t);0==e.scheduleType?t=t.add(e.scheduleEveryXMinute,"minutes"):1==e.scheduleType?t=t.add(e.scheduleEveryXHour,"hours"):2==e.scheduleType?t=t.add(e.scheduleEveryXDay,"days"):3==e.scheduleType?t=t.add(7*e.scheduleEveryXDay,"days"):4==e.scheduleType&&(t=t.add(e.scheduleEveryXMonth,"months"))}}function launchSchedules(){for(var e=0;e<schedules.length;e++){getNextScheduleTime(schedules[e])}}function pauseCrawlJob(e,t){if(e in crawlJobs)for(var n in crawlJobs[e].pause=!0,crawlJobs[e].pauseTimestamp=t,tabs)tabs[n].crawlJob.id==e&&chrome.tabs.sendMessage(parseInt(n,10),{method:"extractPause",data:!0})}$(document).ready(function(){getLocalFiles(),setEnvironment(initConfig),checkRuntime(),getSchedules()}),chrome.tabs.onReplaced.addListener(function(e,t){t in tabs&&(tabs[e]=tabs[t],delete tabs[t],updateStatus("Tab id: "+t+" replaced with tab id: "+e))}),chrome.tabs.onRemoved.addListener(function(e,t){removeTab(e)}),chrome.windows.onRemoved.addListener(function(e){for(var t in crawlJobs)crawlJobs[t].windowId==e&&pauseCrawlJob(t,Date.now())}),chrome.runtime.onMessage.addListener(function(e,t,n){var a=null,o=null,r=t.url;if(t.tab.id in tabs&&(r=tabs[t.tab.id].url),t.tab.id in tabs&&(a=tabs[t.tab.id].crawlJob,o=tabs[t.tab.id]),"capture"==e.method)return capture(n);if("captureDone"==e.method)captureDone();else if("auto-open"==e.method)autoOpen={jobId:e.data.jobId,visitLinkId:e.data.visitLinkId,tabId:t.tab.id},chrome.tabs.create({url:e.data.url,active:!0},function(e){});else if("linkJobToColumn"==e.method){var i=e.data;chrome.tabs.sendMessage(i.tabId,{method:"setLinkJobToColumn",data:i})}else if("downloadLink"==e.method){n({}),downloadLink(e.data)}else if("getSchedules"==e.method)getSchedules();else if("addLinksToCrawl"==e.method)n({}),addLinksToCrawl(a,e.data,r);else if("crawlStart"==e.method)checkQuotaStartCrawl(e.data);else if("isOn"===e.method)isOn=!0;else if("isOff"===e.method)isOn=!1;else if("updateStatus"===e.method)updateStatus(e.data);else if("data"===e.method)n({}),setData(e.data,a,o);else if("extractDone"===e.method)extractDone(a,t,o);else{if("autoExtract"===e.method)return autoExtract(o,n,r,a);if("delete-file"===e.method)chrome.storage.local.remove([e.data.id]),getLocalFiles();else if("getFiles"===e.method)n({method:"getFiles",data:getFiles()});else{if("downloadCSV"===e.method){return downloadCSV(e.data.id,function(e,t){n({method:"downloadCSV",data:{href:e,type:t}})})}if("extractStop"===e.method)deleteExtractByCrawlId(s=e.data);else if("extractPause"===e.method){pauseCrawlJob(s=e.data.crawlJobId,u=e.data.timestamp)}else if("extractResume"===e.method){var s=e.data.crawlJobId,u=e.data.timestamp;for(var l in crawlJobs[s].pause=!1,crawlJobs[s].pauseTimestamp=u,openTabs(crawlJobs[s]),tabs)tabs[l].crawlJob.id==s&&chrome.tabs.sendMessage(parseInt(l,10),{method:"extractResume",data:!0})}}}});